---
title: "ANEEL_SAMP_cleanning_dataset"
author: "Beatriz Couto Ribeiro"
date: "2024-09-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 1. Set Script 
## 1.1. Set Folder
```{r}

getwd()

setwd("C:/Users/wb618493/OneDrive - WBG/Documents/ASA - Privitazation of Distribution/Brazil/Data/DATA_ANEEL")

```


## 1.2. Install and load packages
```{r}

if (!require("pacman")) install.packages("pacman") #pacman will not accept a character vector so the same packages are repeated

pacman::p_load(tidyverse, #packages for data science
               plm, #estimation of linear panel models
               ggplot2,  #creating graphics
               lmtest, #testing linear regression Models
               tseries, #Augmented Dickey-Fuller Test
               clubSandwich, #robustness checks
               sandwich, #robustness checks
               stargazer, #formatting tables for publications
               devtools, #web developer tools 
               rmarkdown, #reproducibility
               tidyr,  #changing the shape and hierarchy of a data set
               dplyr, #grammar of data manipulation
               Synth, #importing and exporting
               SCtools, #extensions for Synthetic Controls Analysis
               MSCMT,  #Multivariate Synthetic Control Method
               gsynth, #generalized Synthetic Control Method
               panelView, #visualize data panels
               httr, # call url
               jsonlite, # use API
               DataExplorer, # Automated Exploratory Data Analysis
               kableExtra, #formatting tables
               webshot, #enable table exportation with kableExtra
               ggrepel, #labels with ggplot
               ggthemes, #different graph themes for ggplot
               ggpubr, #put figures together
               car, # check multicollinearity
               lmtest, # robust standard errors
               #scpi, #  SCM with Multiple Treated Units and Staggered Adoption
               synthdid, # Synthetic Difference in Differences Estimation
               plm, # linear models for panel data
               abind, # Combine Multidimensional Arrays
               readxl, #read xls files
               data.table, # Fast aggregation of large data
               basedosdados,
               bigQueryR,
               googleAuthR) 


```

# 2. Load Files
```{r}

# SAMP ANEEL Files:
samp_1991_2002 <- read_excel("samp_aneel_1991-2002.xlsx")

samp_2003_2007 <- read_excel("samp_aneel_2003-2007.xlsx")

samp_2008_2011 <- read_excel("samp_aneel_2008-2011.xlsx")

samp_2012_2015 <- read_excel("samp_aneel_2012-2015.xlsx")

samp_2016_2020 <- read_excel("samp_aneel_2016-2020.xlsx")

samp_2021_2023 <- read_excel("samp_aneel_2021-2023.xlsx")

# Names before and after privatization:
df_names <- read.csv("names_before_after_privatization_BR_updated.csv")

# DEC & FEC ANEEL Files:
dec_fec_2023 <- read_excel("DEC_FEC_Mensal_Distribuidora_2023.xlsx")

dec_fec_2022 <- read_excel("DEC_FEC_Mensal_Distribuidora_2022.xlsx")

dec_fec_2021 <- read_excel("DEC_FEC_Mensal_Distribuidora_2021.xlsx")

dec_fec_2020 <- read_excel("DEC_FEC_Mensal_Distribuidora_2020.xlsx")

dec_fec_2019 <- read_excel("DEC_FEC_Mensal_Distribuidora_2019.xlsx")

dec_fec_2018 <- read_excel("DEC_FEC_Mensal_Distribuidora_2018.xlsx")

dec_fec_2017 <- read_excel("DEC_FEC_Mensal_Distribuidora_2017.xlsx")

dec_fec_2016 <- read_excel("DEC_FEC_Mensal_Distribuidora_2016.xlsx")

dec_fec_2015 <- read_excel("DEC_FEC_Mensal_Distribuidora_2015.xlsx")

dec_fec_2014 <- read_excel("DEC_FEC_Mensal_Distribuidora_2014.xlsx")

dec_fec_2013 <- read_excel("DEC_FEC_Mensal_Distribuidora_2013.xlsx")

dec_fec_2012 <- read_excel("DEC_FEC_Mensal_Distribuidora_2012.xlsx")

dec_fec_2011 <- read_excel("DEC_FEC_Mensal_Distribuidora_2011.xlsx")

dec_fec_2010 <- read_excel("DEC_FEC_Mensal_Distribuidora_2010.xlsx")

dec_fec_2009 <- read_excel("DEC_FEC_Mensal_Distribuidora_2009.xlsx")

dec_fec_2008 <- read_excel("DEC_FEC_Mensal_Distribuidora_2008.xlsx")

dec_fec_2007 <- read_excel("DEC_FEC_Mensal_Distribuidora_2007.xlsx")

dec_fec_2006 <- read_excel("DEC_FEC_Mensal_Distribuidora_2006.xlsx")

dec_fec_2005 <- read_excel("DEC_FEC_Mensal_Distribuidora_2005.xlsx")

dec_fec_2004 <- read_excel("DEC_FEC_Mensal_Distribuidora_2004.xlsx")

dec_fec_2003 <- read_excel("DEC_FEC_Mensal_Distribuidora_2003.xlsx")

dec_fec_2002 <- read_excel("DEC_FEC_Mensal_Distribuidora_2002.xlsx")

dec_fec_2001 <- read_excel("DEC_FEC_Mensal_Distribuidora_2001.xlsx")

dec_fec_2000 <- read_excel("DEC_FEC_Mensal_Distribuidora_2000.xlsx")

dec_1993_2016 <- read_excel("data_DEC_1993-2016.xlsx")

fec_1993_2016 <- read_excel("data_FEC_1993-2016.xlsx")


```

# 3. Data Preparation
## 3.1. SAMP - ANEEL
### 3.1.1. SAMP - ANEEL: Full merge of 2003-2023 data
```{r}

# Perform the rbind to merge the datasets
samp_2003_2023 <- rbind(samp_2003_2007, samp_2008_2011, samp_2012_2015, 
                            samp_2016_2020, samp_2021_2023)

```

### 3.1.2. SAMP - ANEEL: format the database samp_1991_2002 to have a similar layout to samp_2003_2023
```{r}

#Convert the date column to Date type
samp_1991_2002$MêsAno <- as.Date(samp_1991_2002$MêsAno)

# Extract the year and month and create new columns
samp_1991_2002 <- samp_1991_2002 %>%
  mutate(
    year = year(MêsAno),
    month = month(MêsAno))

# Remove the "MêsAno" column
samp_1991_2002$MêsAno <- NULL


```

### 3.1.3. SAMP - ANEEL: Change Column Names of both datasets, and create a variable "Tax" in samp_2003_2023, and the "RevenueTax" in samp_1991_2002
```{r}

colnames(samp_1991_2002) <- c("Tension", "Firm", "Class", "Consumers", "ConsumptionEnergy", "Demand", "Revenue", "Tax", "Year", "Month")

colnames(samp_2003_2023) <- c("Firm", "Year", "Month", "Tension", "Class", "ConsumptionEnergy", "Revenue", "RevenueTax", "Consumers")


samp_2003_2023 <- samp_2003_2023 %>% mutate(Tax = RevenueTax - Revenue)

samp_1991_2002 <- samp_1991_2002 %>% mutate(RevenueTax = Tax + Revenue)


# Temporarily removing the variable "Demand" from samp_1991_2002, because it is not clear what this number means
samp_1991_2002$Demand <- NULL

```


### 3.1.4. SAMP - ANEEL: Merging both datasets: samp_2003_2023 and samp_1991_2002
```{r}

# Changing "Year" and "Month" variable to numeric, to enable merging 
samp_2003_2023$Year <- as.numeric(samp_2003_2023$Year)
samp_2003_2023$Month <- as.numeric(samp_2003_2023$Month)


# Perform the rbind to merge the datasets
samp_1991_2023 <- full_join(samp_2003_2023, samp_1991_2002, by = c("Firm", "Year", "Month", "Tension", "Class", "ConsumptionEnergy", "Consumers", "Revenue", "RevenueTax", "Tax"))

```

### 3.1.5. SAMP - ANEEL: Rename Variables
```{r}

print(unique(samp_1991_2023$Tension))

# Tension
samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "B1 - Residencial Baixa Renda(Consumo Mensal Superior ao Limite Regional de 200kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 831 a 1.245 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 591 a 1.135 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 342 a 655 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 137 a 341 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 1.437 a 2.154 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal até 136 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 1.136 a 1.436 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 656 a 830 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 342 a 590 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 237 a 341 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 137 a 236 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1- Baixa Renda - Consumo mensal superior a 30 kWh e inferior ou igual a 100 kWh (RES. 945/2010)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1- Baixa Renda - Consumo mensal superior a 100 kWh e inferior ou igual a 220 kWh (RES. 945/2010)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1- Baixa Renda - Consumo mensal inferior ou igual a 30 kWh (RES. 945/2010)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1- Baixa Renda - Consumo mensal superior a 220 kWh (RES. 945/2010)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda(Consumo Mensal Superior ao Limite Regional de 160kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 161 a 180 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 181 a 200 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 201 a 220 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda(Consumo Mensal Superior ao Limite Regional de 220kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 141 a 150 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda(Consumo Mensal Superior ao Limite Regional de 140kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 101 a 140 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 80 a 100 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal até 30 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda(Consumo Mensal Superior ao Limite Regional de 180kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal superior a 30 kWh e inferior a 80kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 151 a 160 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 1.437 a  2.154 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal de 656 a  830 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal superior a 100 até 200 kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda (Consumo mensal  de 1.136 a  1.436 Ah)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa Renda(Consumo Mensal Superior ao Limite Regional de 150kWh)" ~ "B1 - Residencial Baixa Renda",
    Tension == "B1 - Residencial Baixa" ~ "B1 - Residencial Baixa Renda",
    Tension == "B" ~ "B1",
    Tension == "B1 - Residencial" ~ "B1",
    TRUE ~ Tension
  ))

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "B4b - Iluminação Pública - Bulbo de Lâmpada" ~ "B4",
    Tension == "B4a - Iluminação Pública - Rede de Distribuição" ~ "B4",
    Tension == "B4c - Iluminação Pública - Nível de IP acima do Padrão" ~ "B4",
    TRUE ~ Tension
  ))

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "B2 - Rural" ~ "B2",
    Tension == "B2 - Serviço Público de Irrigação" ~ "B2",
    Tension == "B2 - Cooperativa de Eletrificação Rural" ~ "B2",
    TRUE ~ Tension
  ))

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "A4 (2,3 a 25 kV)" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4 - Cooperativa de Eletrificação Rural (2,3 kV a 25 kV)" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4a - Cooperativa de Eletrificação Rural Tipo 1" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4 - Serviço Público de Irrigação (2,3 kV a 25 kV)" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4b - Cooperativa de Eletrificação Rural Tipo 2" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4c - Cooperativa de Eletrificação Rural Tipo 32" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4c - Cooperativa de Eletrificação Rural Tipo 3" ~ "A4 (2,3 a 25 kV)",
    Tension == "A4" ~ "A4 (2,3 a 25 kV)",
    TRUE ~ Tension
  ))

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "A2 (88 a 138 kV)" ~ "A2 (88 a 138 kV)",
    Tension == "A2 - Cooperativa de Eletrificação Rural (88 a 138 kV)" ~ "A2 (88 a 138 kV)",
    Tension == "A2  Serviço Público de Irrigação" ~ "A2 (88 a 138 kV)",
    Tension == "A2" ~ "A2 (88 a 138 kV)",
    TRUE ~ Tension
  ))


samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "A3a (30 kV a 44 kV)" ~ "A3a (30 kV a 44 kV)",
    Tension == "A3a - Serviço Público de Irrigação (30 kV a 44 kV)" ~ "A3a (30 kV a 44 kV)",
    Tension == "A3a - Cooperativa de Eletrificação Rural (30 kV a 44 kV)" ~ "A3a (30 kV a 44 kV)",
    Tension == "A3a" ~ "A3a (30 kV a 44 kV)",
    TRUE ~ Tension
  ))
 

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "A3 ( 69 kV)" ~ "A3 (69 kV)",
    Tension == "A3 - Cooperativa de Eletrificação Rural (69 kV)" ~ "A3 (69 kV)",
    Tension == "A3 - Serviço Público de Irrigação (69 kV))" ~ "A3 (69 kV)",
    Tension == "A3 - Serviço Público de Irrigação (69 kV)" ~ "A3a (30 kV a 44 kV)",
    Tension == "A3" ~ "A3a (30 kV a 44 kV)",
    Tension == "A3 (69 kV)" ~ "A3a (30 kV a 44 kV)",
    TRUE ~ Tension
  ))


samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "B3 - Classe Comercial (Consumo mensal até 820 Ah)" ~ "B3",
    Tension == "B3 - Classe Comercial  (Consumo mensal até 1.436 Ah)" ~ "B3",
    Tension == "B3 - Demais Classes" ~ "B3",
    TRUE ~ Tension
  ))

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "A1" ~ "A1 (230 kV ou mais)",
    TRUE ~ Tension
  ))   

samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Tension = case_when(
    Tension == "AS (Subterrâneo)" ~ "AS",
    TRUE ~ Tension
  )) 

# Class

print(unique(samp_1991_2023$Class))


samp_1991_2023 <- samp_1991_2023 %>%
  mutate(Class = case_when(
    Class == "Rural Aquicultor" ~ "Rural",
    Class == "Rural Irrigante" ~ "Rural",
    Class == "Comercial" ~ "Commercial",
    Class == "Comercial, Serviços e Outras" ~ "Commercial",
    Class == "Serviço Público (água, esgoto e saneamento)" ~ "Public Service",
    Class == "Serviço Público (tração elétrica)" ~ "Public Service",
    Class == "Consumo Próprio" ~ "Own Consumption",
    Class == "Iluminação Pública" ~ "Public Lighting",
    Class == "Poder Público" ~ "Public Government",
    Class == "Serviço Público" ~ "Public Service",
    Class == "Residencial" ~ "Residential",
    TRUE ~ Class
  )) 


```

### 3.1.6. SAMP - ANEEL: Eliminate lines that start with "Applied filters:" and "NA"
```{r}

samp_1991_2023 <- samp_1991_2023 %>%
  filter(!grepl("^Applied filters:", Firm))

# Check for NA's
samp_1991_2023 <- samp_1991_2023 %>%
  filter(!is.na(Firm))
 
num_na_firm <- sum(is.na(samp_1991_2023$Firm))

```

### 3.1.7. SAMP - ANEEL: Merge the datasets: "df_names" and "samp_1991_2023_names", and save
```{r}

samp_1991_2023_names <- samp_1991_2023 %>%
  left_join(df_names, by = c("Firm" = "Before_Privatization")) %>%
  mutate(Firm_After = After_Privatization) %>%
  select(-After_Privatization)  # Optionally remove the After_Privatization column if not needed


#write.csv(samp_1991_2023, "ANEEL_SAMP_1991-2023.csv", row.names = FALSE)

```


# 3.2.  FEC & DEC - ANEEL: Full merge of 2000-2023 data
```{r}

# Perform the rbind to merge the datasets
dec_fec_2000_2023 <- rbind(dec_fec_2023, dec_fec_2022, dec_fec_2021, 
                        dec_fec_2020, dec_fec_2019, dec_fec_2018,
                        dec_fec_2017, dec_fec_2016, dec_fec_2015,
                        dec_fec_2014, dec_fec_2013, dec_fec_2012,
                        dec_fec_2011, dec_fec_2010, dec_fec_2009,
                        dec_fec_2008, dec_fec_2007, dec_fec_2006,
                        dec_fec_2005, dec_fec_2004, dec_fec_2003,
                        dec_fec_2002, dec_fec_2001, dec_fec_2000)

```


### 3.2.1. FEC & DEC - ANEEL: Eliminate lines that start with "Applied filters:" and "NA"
```{r}

dec_fec_2000_2023 <- dec_fec_2000_2023 %>%
  filter(!grepl("^Applied filters:", Distribuidora))

# Check for NA's
dec_fec_2000_2023 <- dec_fec_2000_2023 %>%
  filter(!is.na(Distribuidora))
 
num_na_firm <- sum(is.na(dec_fec_2000_2023_clean$Distribuidora))

print(num_na_firm)

```

### 3.2.2. FEC & DEC - ANEEL: Change Column names, select only concessions and select only some variables
```{r}

# Rename column names
colnames(dec_fec_2000_2023)

colnames(dec_fec_2000_2023) <- c("Firm", "Type", "Year", "Month", "Consumers", "DEC", "FEC", "DECXP", "FECXP", "DECXN", "FECXN", "DECIP", "FECIP", "DECIND", "FECIND",    "DECINE", "FECINE", "DECINC", "FECINC", "DECINO", "FECINO", "DECIPC", "FECIPC", "DECXPC", "FECXPC", "DECXNC", "FECXNC")

dec_fec_2000_2023 <- dec_fec_2000_2023 %>%
  filter(Type!="Permissão")  # remove Permission type

# Select only some columns from the dataset
dec_fec_2000_2023_sel <- dec_fec_2000_2023 %>% select("Firm", "Year", "Month", "DEC", "FEC")


```

### 3.2.3. FEC & DEC - ANEEL: Create a variable with the annual FEC and DEC
```{r}

annual_DEC_FEC <- dec_fec_2000_2023_sel %>%
  group_by(Year, Firm) %>%
  summarise(
    DEC = sum(DEC, na.rm = TRUE),
    FEC = sum(FEC, na.rm = TRUE)
  ) %>%
  ungroup()

# Change columns names
colnames(annual_DEC_FEC) <- c("Year", "Firm", "SAIDI", "SAIFI")

```

### 3.2.4. FEC & DEC - ANEEL: Prepare the DEC & FEC dataset from 1993-2016
```{r}
# Wide to long format
dec_1993_2016_long <- melt(setDT(dec_1993_2016), id.vars = c("EMPRESA"), variable.name = "year")

fec_1993_2016_long <- melt(setDT(fec_1993_2016), id.vars = c("EMPRESA"), variable.name = "year")

# Change columns names
colnames(dec_1993_2016_long) <- c("Firm", "Year", "SAIDI")

colnames(fec_1993_2016_long) <- c("Firm", "Year", "SAIFI")

# Left Join with inflation based on "Year" and "Month"
dec_fec_1993_2016 <- left_join(fec_1993_2016_long, dec_1993_2016_long, by = c("Firm" = "Firm", "Year" = "Year"))

# Convert 'Year' from factor to numeric
dec_fec_1993_2016$Year <- as.numeric(as.character(dec_fec_1993_2016$Year))

# Filter 1993-1999
dec_fec_1993_1999 <- dec_fec_1993_2016 %>%
  filter(Year < 2000)  # remove Permission type

# Convert all names in the 'Firm' column to uppercase
dec_fec_1993_1999$Firm <- toupper(dec_fec_1993_1999$Firm)

# Save the dataset to harmonize the names
write.csv(dec_fec_1993_1999, "dec_fec_1993_1999.csv", row.names = FALSE)



```

### 3.2.5. FEC & DEC - ANEEL: Merge the dataset dec_fec_1993_1999 and annual_DEC_FEC 
```{r}

# Convert all names in the 'Firm' column to uppercase
annual_DEC_FEC$Firm <- toupper(annual_DEC_FEC$Firm)

# Perform the rbind to merge the datasets
fec_dec_1993_2023 <- rbind(dec_fec_1993_1999, annual_DEC_FEC)


```


### 3.2.6. FEC & DEC - ANEEL: Select only Rede Group related distribution firms
```{r}

fec_dec_1993_2023_Rede <- fec_dec_1993_2023 %>%
  mutate(Firm = case_when(
    Firm == "EQUATORIAL PA" ~ "CELPA",
    Firm == "ENERGISA ELO" ~ "CFLO",
    Firm == "ENERGISA BR" ~ "EEB",
    Firm == "ENERGISA CI" ~ "EnergisaSulSudeste",
    Firm == "ENERGISA SUL-SUDESTE" ~ "EnergisaSulSudeste",
    Firm == "ENERGISA VP" ~ "EDEVP",
    Firm == "ENERGISA NA" ~ "CNEE",
    Firm == "ENERGISA MS" ~ "ENERSUL",
    Firm == "ENERGISA MT" ~ "CEMAT",
    Firm == "ENERGISA TO" ~ "CELTINS",
    TRUE ~ Firm
  ))


```


# Harmonize names and include the the Privatization data
```{r}

# Convert all names in the 'Firm' column to uppercase
df_names$Before_Privatization <- toupper(df_names$Before_Privatization)

# Convert the 'Firm' column to UTF-8 encoding to handle any special characters
df_names$After_Privatization <- iconv(df_names$After_Privatization, from = "latin1", to = "UTF-8")

# Convert all names in the 'Firm' column to uppercase
df_names$After_Privatization <- toupper(df_names$After_Privatization)

fec_dec_1993_2023_names <- fec_dec_1993_2023 %>%
  left_join(df_names, by = c("Firm" = "Before_Privatization"), relationship = "many-to-many") %>%
  mutate(Firm_After = After_Privatization) %>%
  select(-After_Privatization)  # Optionally remove the After_Privatization column if not needed


# Group by 'Year' and 'Firm_After' and sum the numeric columns, keeping NAs
summed_data <- fec_dec_1993_2023_names %>%
  group_by(Year, Firm_After) %>%
  summarise(across(where(is.numeric), ~sum(.x))) %>%
  ungroup()


```



# 4. Analysis 
## 4.1. SAMP - ANEEL
### 4.1.1. SAMP - ANEEL: Retrieve inflation data IPCA from Base dos dados: https://basedosdados.org/dataset/ea4d07ca-e779-4d77-bcfa-b0fd5ebea828?table=f1fd2eb7-467a-403b-8f1c-2de8eff354e6
```{r}
## set the google cloud console ID and project
basedosdados::set_billing_id("inflation-ipca")

#deflate Tariff with monthly IPCA
#create monthly deflator
#ipca_monthly <- basedosdados::read_sql(query = "SELECT ano, mes, indice, variacao_anual, variacao_doze_meses FROM basedosdados.br_ibge_ipca.mes_brasil")

ipca_monthly_trans<-ipca_monthly%>%arrange(ano,mes)
ipca_monthly_trans<-ipca_monthly_trans%>%mutate(deflator93=indice/100)%>%
  mutate(deflator122023=deflator93[ano==2023 & mes==12]/deflator93)
ipca_monthly_trans<-ipca_monthly_trans%>%select(ano,mes,deflator122023)
ipca_monthly_trans <- type.convert(ipca_monthly_trans, as.is = TRUE) 

colnames(ipca_monthly_trans) <- c("Year", "Month", "deflator122023")

#write.csv(ipca_monthly_trans, "ipca_deflator_monthly.csv", row.names = FALSE)


```


### 4.1.2. SAMP - ANEEL:  Create a new variables "Tariff"
```{r}
#Create variable Tariff
df_1991_2023 <- samp_1991_2023_names %>%
  mutate(Tariff = if_else(!is.na(ConsumptionEnergy) & ConsumptionEnergy>0 ,Revenue / ConsumptionEnergy, NA))

# Left Join with inflation based on "Year" and "Month"
df_joined <- left_join(df_1991_2023, ipca_monthly_trans, by = c("Year" = "Year", "Month" = "Month"))


#Impute monthly values by taking the average consumption of that year

# #Create Tariff 
# df_annual <- df_annual %>%
#   mutate(Tariff = if_else(!is.na(consumption),revenue / consumption, NA))

# Deflate the Tariff variable
df_joined<-df_joined%>%mutate(Tariff_1223_BRL= Tariff*deflator122023,
                              Revenue_1223_BRL=Revenue*deflator122023,
                              revenue_tax_1223_BRL=RevenueTax*deflator122023,
                              tax_1223_BRL=Tax*deflator122023)


# create annual data set
 df_annual <- df_joined %>%
   group_by(Firm_After, Year, Class, Type, Privatization) %>%
   summarize(
     revenue = ifelse(all(is.na(Revenue_1223_BRL)), NA_real_, sum(Revenue_1223_BRL, na.rm = TRUE)),
     revenue_tax = ifelse(all(is.na(revenue_tax_1223_BRL)), NA_real_, sum(revenue_tax_1223_BRL, na.rm = TRUE)),
     consumption= ifelse(all(is.na(ConsumptionEnergy)), NA_real_, sum(ConsumptionEnergy, na.rm = TRUE)),
     consumers = ifelse(all(is.na(Consumers)), NA_real_, sum(Consumers, na.rm = TRUE)),
     tax = ifelse(all(is.na(tax_1223_BRL)), NA_real_, sum(tax_1223_BRL, na.rm = TRUE)))%>%
   mutate(Tariff_1223_BRL=revenue/consumption)
 

#Create relative time variable (t0= year of privatization)
df_annual <- df_annual %>%
  group_by(Firm_After) %>%
  mutate(
    t_privat = if_else(Privatization > 1, Year - Privatization, NA_real_),
    owner_type =if_else(Privatization==0, "state-owned",if_else(Privatization==1, "always private", "privatized")))


#Growth variable
df_annual <- df_annual %>% filter(Year > 1993) %>%
  group_by(Firm_After, Class) %>%
  mutate(
    tariff_growth = if_else(
      !is.na(t_privat) & any(t_privat == 0),  # Only calculate when t_privat is not NA and there's at least one t_privat == 0
      (Tariff_1223_BRL / Tariff_1223_BRL[which(t_privat == 0)][1]) * 100,  # Use the first instance where t_privat == 0
      NA_real_  # Otherwise, keep it as NA
    ),
    tariff_growth_rel2015 = if_else(!is.na(Tariff_1223_BRL),
      (Tariff_1223_BRL / Tariff_1223_BRL[which(Year == 2015)][1]) * 100,  # Use the first instance where t_privat == 0
      NA_real_  # Otherwise, keep it as NA
  )) %>%
  ungroup()  # Ungroup after mutate



#filter out companies of type = permission

df_annual<-df_annual%>%filter(Type!="Permission")

```

### 4.1.3. SAMP - ANEEL: Growth Rate Analysis
```{r}
#Create average growth rate, median, and 95th confidence interval of mean
# Step 1: Calculate summary statistics by Class and t_privat
df_summary <- df_annual %>%group_by(Class, t_privat) %>%
  summarize(
    mean_tariff_growth = mean(tariff_growth, na.rm = TRUE),
    median_tariff_growth = median(tariff_growth, na.rm = TRUE),
    n = n(),
    se = sd(tariff_growth, na.rm = TRUE) / sqrt(n),  # Standard error
    ci_lower = mean_tariff_growth - qt(0.975, df = n - 1) * se,  # 95% confidence interval lower bound
    ci_upper = mean_tariff_growth + qt(0.975, df = n - 1) * se   # 95% confidence interval upper bound
  ) %>%
  ungroup()

# Step 2: Create the facet wrap graph
# Step 2: Create the facet wrap graph with free y-scale, vertical line at t_privat = 0, and y-axis limits

# Filter the data for the specified classes
df_filtered <- df_summary %>%
  filter(Class %in% c("Commercial", "Industrial", "Residential", "Rural"))

# Create the plot with the filtered data and larger text sizes
g_tariff <- ggplot(df_filtered, aes(x = t_privat, y = mean_tariff_growth)) +
  geom_line(aes(group = Class), color = "blue") +  # Line for the mean
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = Class), alpha = 0.2) +  # Confidence interval
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +  # Vertical line at t_privat = 0
  scale_x_continuous(breaks = seq(-10,10,2), limits = c(-10, 10)) +  # X-axis limits
  scale_y_continuous(breaks = seq(60,200,20), limits = c(60,200)) +  # Y-axis limits
  labs(
    x = "Years before/after privatization",
    y = "Revenue in constant 2023 BRL/MWh"
  ) +
  facet_wrap(~Class, scales = "free_y", ncol = 2, nrow = 4) +  # Organize facets in 2 columns and 4 rows
  theme_bw() +
  theme(
    legend.position = "none",   # Remove legend
    text = element_text(size = 12),  # Set text size to 8pt for all text
    axis.text = element_text(size = 12),  # Set axis text size
    axis.title = element_text(size = 12),  # Set axis titles size
    strip.text = element_text(size = 12)  # Set facet labels size
  )

print(g_tariff)

# Save the plot as an image
ggsave("tariff_growth_plot.png", plot = g_tariff, width = 10, height = 8, dpi = 300)



```

### 4.1.4. SAMP - ANEEL: Absolute time graph
```{r}
df_summary_2015 <- df_annual %>%
  group_by(Class, Year, owner_type) %>%
  summarize(
    mean_tariff_growth_rel2015 = mean(tariff_growth_rel2015, na.rm = TRUE),
    mean_tariff_BRL23=mean(Tariff_1223_BRL,na.rm = TRUE),
    median_tariff_growth_rel2015 = median(tariff_growth_rel2015, na.rm = TRUE),
    n_rel2015 = n(),
    se = sd(tariff_growth_rel2015, na.rm = TRUE) / sqrt(n_rel2015),  # Standard error
    ci_lower_2015 = mean_tariff_growth_rel2015 - qt(0.975, df = n_rel2015 - 1) * se,  # 95% confidence interval lower bound
    ci_upper_2015 = mean_tariff_growth_rel2015 + qt(0.975, df = n_rel2015 - 1) * se   # 95% confidence interval upper bound
  )

df_summary_2015 <- df_summary_2015 %>%
  filter(Class %in% c("Commercial", "Industrial", "Residential", "Rural"))

#absolute time graph
g_tariff_growthrel2015 <- ggplot(df_summary_2015%>%filter(Year>1994), aes(x = Year, y = mean_tariff_growth_rel2015, color=owner_type)) +
  geom_line() +  # Line for the mean
  scale_x_continuous(breaks = seq(1995, 2023, 4)) +  # X-axis breaks only, without limits
  labs(
    x = "",
    y = "Revenue growth in constant 2023 BRL/MWh (2015=100)"
  ) +
  facet_wrap(~Class, scales = "free_y", ncol = 2, nrow = 4) +  # Organize facets in 2 columns and 4 rows
  theme_bw() +
  theme(
    legend.position = "bottom",   # Remove legend
    text = element_text(size = 12),  # Set text size to 12pt for all text
    axis.text = element_text(size = 12),  # Set axis text size
    axis.title = element_text(size = 12),  # Set axis titles size
    strip.text = element_text(size = 12)  # Set facet labels size
  )

print(g_tariff_rel2015)

ggsave("tariff_growth_plot_ownertype.png", plot = g_tariff_growthrel2015, width = 10, height = 8, dpi = 300)

g_tariff_rel2015 <- ggplot(df_summary_2015 %>% filter(Year > 1994), aes(x = Year, y = mean_tariff_BRL23, color = owner_type)) +
  geom_line() +  # Line for the mean
  scale_x_continuous(breaks = seq(1995, 2023, 4)) +  # X-axis breaks only, without limits
  scale_y_continuous(breaks = seq(300,800,50), limits = c(300,800)) +  # Y-axis limits
  labs(
    x = "",
    y = "Revenue in constant 2023 BRL/MWh",
    color = "Ownership"  # Label for the legend
  ) +
  facet_wrap(~Class, scales = "free_y", ncol = 2, nrow = 4) +  # Organize facets in 2 columns and 4 rows
  theme_bw() +
  theme(
    legend.position = "bottom",   # Set legend at the bottom
    text = element_text(size = 12),  # Set text size to 12pt for all text
    axis.text = element_text(size = 12),  # Set axis text size
    axis.title = element_text(size = 12),  # Set axis titles size
    strip.text = element_text(size = 12)  # Set facet labels size
  )

print(g_tariff_rel2015)

ggsave("tariff_plot_ownertype.png", plot = g_tariff_rel2015, width = 10, height = 8, dpi = 300)

```


```{r}

# # Selecionar as variáveis "Firm", "Year", "Month" e "Consumers"
# samp_selected <- samp_1991_2023 %>%
#   select(Firm, Year, Month, Consumers)
# 
# # Criar uma nova coluna combinando "Year" e "Month"
# samp_selected <- samp_selected %>%
#   unite("Year_Month", Year, Month, sep = "_")
# 
# # Transformar o dataset em formato wide
# samp_wide <- samp_selected %>%
#   pivot_wider(names_from = Year_Month, values_from = Consumers)

```


## 4.2. FEC & DEC - ANEEL
### 4.2.1. FEC & DEC - ANEEL Plots: CELPA
```{r}
# Filter dataset for only CELPA
fec_dec_1993_2023_Rede_celpa <- fec_dec_1993_2023_Rede %>%
  filter(Firm == "CELPA")

# Line plot for CELPA FEC
celpa_fec <- ggplot(fec_dec_1993_2023_Rede_celpa, aes(x = Year, y = SAIFI)) +
  geom_line(color = "blue", na.rm = TRUE) +  # Set a specific color for CELPA
    geom_vline(xintercept = 2012, linetype = "dashed", color = "gray", size = 1) +  # Vertical line at 2012
  labs(title = "SAIFI",
       x = "Year", 
       y = "DEC") +
  theme_bw() +
  scale_x_continuous(breaks = seq(1998, 2023, 2), limits = c(1998, 2023)) +  # X-axis limits and breaks
  scale_y_continuous(breaks = seq(0, 60, 10), limits = c(0, 60)) +  # Y-axis limits
  theme(
    text = element_text(size = 12),  # Text size
    axis.text = element_text(size = 12),  # Axis text size
    axis.title = element_text(size = 12)   # Axis titles size
  )

print(celpa_fec)

# Save the plot as an image
#ggsave("plot_onlyCelpa_netproft.png", plot = celpa_netproft, width = 10, height = 8, dpi = 300)

# Line plot for CELPA DC
celpa_dec <- ggplot(fec_dec_1993_2023_Rede_celpa, aes(x = Year, y = SAIDI)) +
  geom_line(color = "blue", na.rm = TRUE) +  # Set a specific color for CELPA
    geom_vline(xintercept = 2012, linetype = "dashed", color = "gray", size = 1) +  # Vertical line at 2012
    labs(title = "SAIDI",
       x = "Year", 
       y = "DEC") +
  theme_bw() +
  scale_x_continuous(breaks = seq(1998, 2023, 2), limits = c(1998, 2023)) +  # X-axis limits and breaks
  scale_y_continuous(breaks = seq(0, 120, 10), limits = c(0, 120)) +  # Y-axis limits
  theme(
    text = element_text(size = 12),  # Text size
    axis.text = element_text(size = 12),  # Axis text size
    axis.title = element_text(size = 12)   # Axis titles size
  )

print(celpa_dec)

# Save the plot as an image
#ggsave("plot_onlyCelpa_debtEquity.png", plot = celpa_debtEquity, width = 10, height = 8, dpi = 300)

```

### 4.2.2. FEC & DEC - ANEEL Plots: Merged firms under Energisa Sul-Sudeste
```{r}
# Filter dataset under Energisa Sul-Sudeste
fec_dec_1993_2023_Rede_SulSudeste <- fec_dec_1993_2023_Rede %>%
  filter(Firm %in% c("EEB", "CFLO", "CNEE", "EDEPV", "EnergisaSulSudeste"))

# Line plot for CELPA netprofit_margin
Rede_SulSudeste_fec <- ggplot(fec_dec_1993_2023_Rede_SulSudeste, aes(x = Year, y = SAIFI, color = Firm, color = Firm)) +
  geom_line(na.rm = TRUE) +  # Set a specific color for CELPA
  geom_vline(xintercept = 2012, linetype = "dashed", color = "lightgray", size = 1) +  # Vertical line at 2012
  geom_vline(xintercept = 2016, linetype = "dashed", color = "darkgray", size = 1) +  # Vertical line at 2012
  labs(title = "SAIFI for EEB, CFLO, CNEE, EDEPV, CAIUA, Energisa Sul-Sudeste",
       x = "Year", 
       y = "SAIFI") +
  theme_bw() +
  scale_x_continuous(breaks = seq(1998, 2023, 2), limits = c(1998, 2023)) +  # X-axis limits and breaks
  scale_y_continuous(breaks = seq(0, 20, 5), limits = c(0, 20)) +  # Y-axis limits
  theme(
    text = element_text(size = 12),  # Text size
    axis.text = element_text(size = 12),  # Axis text size
    axis.title = element_text(size = 12)   # Axis titles size
  )

print(Rede_SulSudeste_fec)

# Save the plot as an image
#ggsave("plot_onlyMerged_netproft.png", plot = merged_netproft, width = 10, height = 8, dpi = 300)

# Line plot for debtequity_ratio for all firms except CELPA
Rede_SulSudeste_dec <- ggplot(fec_dec_1993_2023_Rede_SulSudeste, aes(x = Year, y = SAIDI, color = Firm, group = Firm)) +
  geom_line(na.rm = TRUE) +
  geom_vline(xintercept = 2012, linetype = "dashed", color = "lightgray", size = 1) +  # Vertical line at 2012
  geom_vline(xintercept = 2016, linetype = "dashed", color = "darkgray", size = 1) +  # Vertical line at 2012
  labs(title = "SAIDI for EEB, CFLO, CNEE, EDEPV, CAIUA, Energisa Sul-Sudeste",
       x = "Year", 
       y = "SAIDI",
       color = "Firm") +  # Label for the legend
  theme_bw() +
  scale_x_continuous(breaks = seq(1998, 2023, 2), limits = c(1998, 2023)) +  # X-axis limits and breaks
  scale_y_continuous(breaks = seq(0, 20, 5), limits = c(0, 20)) +  # Y-axis limits
  theme(
    legend.position = "right",  # Legend on the right
    text = element_text(size = 12),  # Text size
    axis.text = element_text(size = 12),  # Axis text size
    axis.title = element_text(size = 12)   # Axis titles size
  )

print(Rede_SulSudeste_dec)

# Save the plot as an image
#ggsave("plot_onlyMerged_debtEquity.png", plot = merged_debtEquity, width = 10, height = 8, dpi = 300)

```


### 4.2.3. FEC & DEC - ANEEL Plots: All firms
```{r}

# Facet Wrap
# Filter dataset for only CELPA
fec_dec_1993_2023_Rede_sel <- fec_dec_1993_2023_Rede %>%
  filter(Firm %in% c("CELTINS", "ENERSUL", "CEMAT"))

# Line plot for netprofit_margin for each firm, ignoring NA values
sel_fec <- ggplot(fec_dec_1993_2023_Rede_sel, aes(x = Year, y = SAIFI, color = Firm)) +
  geom_line(na.rm = TRUE) +
   geom_vline(xintercept = 2012, linetype = "dashed", color = "gray", size = 1) +  # Vertical line at 2012
  labs(title = "SAIFI",
       x = "Year", 
       y = "SAIFI",
    color = "Firm") + # Label for the legend
  theme_bw()+  # Line for the mean
  scale_x_continuous(breaks = seq(1998, 2023, 2), limits = c(1998, 2023)) +  # X-axis breaks only, without limits
   scale_y_continuous(breaks = seq(0,60, 10), limits = c(0,60)) +  # Y-axis limits
  facet_wrap(~ Firm, ncol = 3)+
  theme(
    legend.position = "none",   # Set legend at the bottom
    text = element_text(size = 12),  # Set text size to 12pt for all text
    axis.text = element_text(size = 12),  # Set axis text size
    axis.title = element_text(size = 12),  # Set axis titles size
    strip.text = element_text(size = 12)  # Set facet labels size
  )

print(sel_fec)

# Save the plot as an image
#ggsave("plot_onlyOthers_netproft.png", plot = others_netproft, width = 18, height = 8, dpi = 300)

# Line plot for debtequity_ratio for each firm, ignoring NA values
sel_dec <- ggplot(fec_dec_1993_2023_Rede_sel, aes(x = Year, y = SAIDI, color = Firm)) +
  geom_line(na.rm = TRUE) +
   geom_vline(xintercept = 2012, linetype = "dashed", color = "gray", size = 1) +  # Vertical line at 2012
  labs(title = "SAIDI",
       x = "Year", 
       y = "SAIDI",
    color = "Firm") + # Label for the legend
  theme_bw()+
    scale_x_continuous(breaks = seq(1998, 2023, 2), limits = c(1998, 2023)) +  # X-axis breaks only, without limits
  scale_y_continuous(breaks = seq(0, 90, 10), limits = c(0,90)) +  # Y-axis limits
  facet_wrap(~ Firm, ncol = 3)+
  theme(
    legend.position = "none",   # Set legend at the bottom
    text = element_text(size = 12),  # Set text size to 12pt for all text
    axis.text = element_text(size = 12),  # Set axis text size
    axis.title = element_text(size = 12),  # Set axis titles size
    strip.text = element_text(size = 12)  # Set facet labels size
  )

print(sel_dec)

# Save the plot as an image
#ggsave("plot_onlyOthers_debtEquity.png", plot = others_debtEquity, width = 18, height = 8, dpi = 300)

```




